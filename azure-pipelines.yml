trigger:
  batch: true
  branches:
    include:
      - "*"

pool:
  name: DAS - Continuous Integration
  workspace:
    clean: all

resources:
  repositories:
  - repository: self
  - repository: das-platform-building-blocks
    type: github
    name: SkillsFundingAgency/das-platform-building-blocks
    ref: refs/heads/master
    endpoint: GitHub (SFA)
  pipelines:
    - pipeline: das-employer-config
      project: Digital Apprenticeship Service
      source: das-employer-config
      branch: master
pr:
  - master

# variables:
  # - group: RELEASE Management Resources
  # - group: RELEASE das-levy-transfer-matching-api

stages:
- stage: Build
  jobs:
  - template: pipeline-templates/job/code-build.yml

# - stage: Deploy_AT
#   dependsOn: Build
#   displayName: Deploy to AT
#   pool:
#     name: DAS - Continuous Deployment
#   variables:
#   - group: DevTest Management Resources
#   - group: AT DevTest Shared Resources
#   - group: AT das-levy-transfer-matching-api
#   jobs:
#   - template: azure-pipelines-templates/deploy/job/arm-deploy.yml@das-platform-building-blocks
#     parameters:
#       ServiceConnection: SFA-DAS-DevTest-ARM
#       SubscriptionId: $(SubscriptionId)
#       Location: $(ResourceGroupLocation)
#       Environment: DEV
#       TemplatePath: $(Pipeline.Workspace)/LevyTransferMatchingApi/azure/template.json
#       ParametersPath: $(Pipeline.Workspace)/LevyTransferMatchingApi/azure/template.parameters.json
#       ConfigSchemaPath: $(Pipeline.Workspace)/das-employer-config/Configuration/das-levy-transfer-matching-api
#       TemplateSecrets:
#         LoggingRedisConnectionString: $(LoggingRedisConnectionString)
#         ConfigurationStorageConnectionString: $(ConfigurationStorageConnectionString)
#   - deployment: DeployDACPAC
#     environment: DEV
#     workspace:
#       clean: all
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#           - task: SqlAzureDacpacDeployment@1
#             displayName: Execute Azure SQL DacpacTask
#             inputs:
#               azureSubscription: '<Azure service connection>'
#               ServerName: $(SharedSQLServerName)
#               DatabaseName: $[dependencies.DeployDACPAC.outputs['DeployDACPAC.ArmOutputs.ResourceGroupName']]
#               SqlUsername: $(SharedSQLServerUsername)
#               SqlPassword: $(SharedSQLServerPassword)
#               DacpacFile: $(Pipeline.Workspace)/LevyTransferMatchingApi/SFA.DAS.LevyTransferMatching.Database.zip
  # - template: pipeline-templates/job/web-deploy.yml
  #   parameters:
  #     DeploymentApprovals: DEV
  #     ServiceConnection: SFA-DAS-DevTest-ARM
  #     DeploymentPackagePath: $(Pipeline.Workspace)/LevyTransferMatchingApi/SFA.DAS.LevyTransferMatching.Api.zip
